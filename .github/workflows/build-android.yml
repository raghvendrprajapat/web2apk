- name: Apply branding assets from URL(s) (FIXED)
  shell: bash
  working-directory: android
  run: |
    set -euo pipefail

    ICON_SRC="${{ github.event.inputs.APP_ICON_URL }}"
    SPLASH_SRC="${{ github.event.inputs.SPLASH_SCREEN_URL }}"

    if [ -z "$ICON_SRC" ] && [ -z "$SPLASH_SRC" ]; then
      echo "No branding URLs provided — skipping branding download"; exit 0
    fi

    # Helper: download file to target path
    dl() {
      url="$1"; out="$2"
      echo "Downloading: $url -> $out"
      curl -sfSL "$url" -o "$out" || { echo "⚠️ curl failed for $url (ignored)"; }
    }

    # Download icons
    if [ -n "$ICON_SRC" ]; then
      if [[ "$ICON_SRC" =~ \.png$ ]]; then
        echo "ICON_SRC is direct PNG: $ICON_SRC"
        dl "$ICON_SRC" /tmp/icon_base.png
      else
        case "$ICON_SRC" in */) ;; *) ICON_SRC="$ICON_SRC/";; esac
        echo "ICON_SRC is folder: $ICON_SRC"
        dl "${ICON_SRC}icon_xxxhdpi.png" /tmp/icon_xxxhdpi.png
        dl "${ICON_SRC}icon_xxhdpi.png"  /tmp/icon_xxhdpi.png
        dl "${ICON_SRC}icon_xhdpi.png"   /tmp/icon_xhdpi.png
        dl "${ICON_SRC}icon_hdpi.png"    /tmp/icon_hdpi.png
        dl "${ICON_SRC}icon_mdpi.png"    /tmp/icon_mdpi.png
      fi
    fi

    # Download splash
    if [ -n "$SPLASH_SRC" ]; then
      if [[ "$SPLASH_SRC" =~ \.png$ ]]; then
        dl "$SPLASH_SRC" /tmp/splash.png
      else
        case "$SPLASH_SRC" in */) ;; *) SPLASH_SRC="$SPLASH_SRC/";; esac
        dl "${SPLASH_SRC}splash.png" /tmp/splash.png
      fi
    fi

    # ═══════════════════════════════════════════════════════
    # CRITICAL FIX: Proper Android Adaptive Icon Structure
    # ═══════════════════════════════════════════════════════

    # Clean old resources
    echo "🧹 Cleaning old icon resources..."
    rm -rf app/src/main/res/mipmap-* app/src/main/res/drawable* || true

    # Create all required directories
    echo "📁 Creating resource directories..."
    for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
      mkdir -p "app/src/main/res/mipmap-${density}"
    done
    mkdir -p app/src/main/res/mipmap-anydpi-v26
    mkdir -p app/src/main/res/drawable
    mkdir -p app/src/main/res/drawable-nodpi

    # ═══════════════════════════════════════════════════════
    # STEP 1: Install Legacy Icons (for older Android versions)
    # ═══════════════════════════════════════════════════════
    
    if [ -f /tmp/icon_base.png ]; then
      # Single file provided - copy to all densities
      echo "📦 Installing base icon to all densities..."
      for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
        cp /tmp/icon_base.png "app/src/main/res/mipmap-${density}/ic_launcher.png"
        cp /tmp/icon_base.png "app/src/main/res/mipmap-${density}/ic_launcher_round.png"
      done
    else
      # Multiple density files provided
      echo "📦 Installing density-specific icons..."
      [ -f /tmp/icon_mdpi.png ]    && cp /tmp/icon_mdpi.png    app/src/main/res/mipmap-mdpi/ic_launcher.png
      [ -f /tmp/icon_hdpi.png ]    && cp /tmp/icon_hdpi.png    app/src/main/res/mipmap-hdpi/ic_launcher.png
      [ -f /tmp/icon_xhdpi.png ]   && cp /tmp/icon_xhdpi.png   app/src/main/res/mipmap-xhdpi/ic_launcher.png
      [ -f /tmp/icon_xxhdpi.png ]  && cp /tmp/icon_xxhdpi.png  app/src/main/res/mipmap-xxhdpi/ic_launcher.png
      [ -f /tmp/icon_xxxhdpi.png ] && cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
      
      # Round icons (same as square for simplicity)
      [ -f /tmp/icon_mdpi.png ]    && cp /tmp/icon_mdpi.png    app/src/main/res/mipmap-mdpi/ic_launcher_round.png
      [ -f /tmp/icon_hdpi.png ]    && cp /tmp/icon_hdpi.png    app/src/main/res/mipmap-hdpi/ic_launcher_round.png
      [ -f /tmp/icon_xhdpi.png ]   && cp /tmp/icon_xhdpi.png   app/src/main/res/mipmap-xhdpi/ic_launcher_round.png
      [ -f /tmp/icon_xxhdpi.png ]  && cp /tmp/icon_xxhdpi.png  app/src/main/res/mipmap-xxhdpi/ic_launcher_round.png
      [ -f /tmp/icon_xxxhdpi.png ] && cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png
    fi

    # ═══════════════════════════════════════════════════════
    # STEP 2: Create Adaptive Icon Resources (Android 8.0+)
    # ═══════════════════════════════════════════════════════
    
    ICON_SOURCE=""
    if [ -f /tmp/icon_base.png ]; then
      ICON_SOURCE="/tmp/icon_base.png"
    elif [ -f /tmp/icon_xxxhdpi.png ]; then
      ICON_SOURCE="/tmp/icon_xxxhdpi.png"
    fi

    if [ -n "$ICON_SOURCE" ]; then
      echo "🎨 Creating adaptive icon resources..."
      
      # Copy foreground/background to ALL density folders
      for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
        cp "$ICON_SOURCE" "app/src/main/res/mipmap-${density}/ic_launcher_foreground.png"
        cp "$ICON_SOURCE" "app/src/main/res/mipmap-${density}/ic_launcher_background.png"
      done

      # Create adaptive icon XML (references the mipmap resources above)
      cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml << 'ADAPTIVE_XML'
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@mipmap/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>
ADAPTIVE_XML

      cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml << 'ADAPTIVE_ROUND_XML'
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@mipmap/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>
ADAPTIVE_ROUND_XML

      echo "✅ Adaptive icons created successfully"
    fi

    # ═══════════════════════════════════════════════════════
    # STEP 3: Install Splash Screen
    # ═══════════════════════════════════════════════════════
    
    if [ -f /tmp/splash.png ]; then
      echo "🖼️ Installing splash screen..."
      cp /tmp/splash.png app/src/main/res/drawable-nodpi/splash.png
      cp /tmp/splash.png app/src/main/res/drawable/splash.png

      cat > app/src/main/res/drawable/launch_background.xml << 'SPLASH_XML'
<?xml version="1.0" encoding="utf-8"?>
<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:drawable="@android:color/white" />
    <item>
        <bitmap 
            android:gravity="center" 
            android:src="@drawable/splash" />
    </item>
</layer-list>
SPLASH_XML
      echo "✅ Splash screen installed"
    fi

    # ═══════════════════════════════════════════════════════
    # STEP 4: Debug Output
    # ═══════════════════════════════════════════════════════
    
    echo ""
    echo "═══════════════════════════════════════════════════════"
    echo "📋 BRANDING INSTALLATION SUMMARY"
    echo "═══════════════════════════════════════════════════════"
    
    echo ""
    echo "🔍 Downloaded files:"
    ls -lh /tmp/icon_* /tmp/splash.png 2>/dev/null || echo "  (no files found)"
    
    echo ""
    echo "🔍 Installed legacy icons:"
    find app/src/main/res/mipmap-* -name "ic_launcher*.png" -type f | head -20
    
    echo ""
    echo "🔍 Adaptive icon resources:"
    ls -lh app/src/main/res/mipmap-anydpi-v26/ 2>/dev/null || echo "  (no adaptive icons)"
    
    echo ""
    echo "🔍 Adaptive icon XML content:"
    if [ -f app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml ]; then
      cat app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
    else
      echo "  ⚠️ ic_launcher.xml not found"
    fi
    
    echo ""
    echo "🔍 Splash resources:"
    ls -lh app/src/main/res/drawable*/splash.png 2>/dev/null || echo "  (no splash found)"
    
    echo ""
    echo "✅ Branding installation complete"
    echo "═══════════════════════════════════════════════════════"
