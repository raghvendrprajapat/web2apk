name: Build Android (Signed APK & AAB)

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App Name"
        required: true
        default: "My Web2APK"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2apk"
      WEB_URL:
        description: "Web App URL (https://...)"
        required: true
        default: "https://example.com"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Repo checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Java 17 (Android Gradle Plugin के साथ सबसे compatible)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3) Node 20 (बिना cache, ताकि lockfile error न आये)
      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 4) Android SDK (latest cmdline-tools; कोई deprecated input नहीं)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "latest"

      # 5) न्यूनतम Node प्रोजेक्ट और Capacitor deps
      - name: Ensure Node project & Capacitor deps
        run: |
          if [ ! -f package.json ]; then
            npm init -y
          fi
          npm i @capacitor/core @capacitor/cli @capacitor/android --save
          mkdir -p dist
          echo '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Web2APK</title></head><body><h1>Web2APK</h1></body></html>' > dist/index.html

      # 6) capacitor.config.json बनाओ (inputs से)
      - name: Generate Capacitor config
        run: |
          node -e '
            const fs = require("fs");
            const cfg = {
              appId: process.env.APP_ID,
              appName: process.env.APP_NAME,
              webDir: "dist",
              server: { url: process.env.WEB_URL, cleartext: true }
            };
            fs.writeFileSync("capacitor.config.json", JSON.stringify(cfg, null, 2));
          '
        env:
          APP_NAME: ${{ github.event.inputs.APP_NAME }}
          APP_ID:   ${{ github.event.inputs.APP_ID }}
          WEB_URL:  ${{ github.event.inputs.WEB_URL }}

      # 7) Android platform add + sync
      - name: Add Android & Sync
        run: |
          npx cap add android || true
          npx cap sync android

      # 8) Keystore decode (Secret: KEYSTORE_BASE64)
      - name: Decode keystore from secret
        run: |
          mkdir -p android
          echo "${KEYSTORE_BASE64}" | base64 -d > android/my-release-key.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      # 9) Keystore verify (गलत alias/pass हो तो यहीं पकड़ लो)
      - name: Verify keystore (alias & passwords)
        run: |
          keytool -list -v \
            -keystore android/my-release-key.jks \
            -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
            -alias "${{ secrets.KEY_ALIAS }}" \
            -keypass "${{ secrets.KEY_PASSWORD }}"

      # 10) Signed build (APK + AAB)
      - name: Build (release, signed)
        working-directory: android
        run: |
          chmod +x ./gradlew
          ./gradlew clean
          ./gradlew assembleRelease bundleRelease \
            -Pandroid.injected.signing.store.file=$PWD/my-release-key.jks \
            -Pandroid.injected.signing.store.password="${{ secrets.KEYSTORE_PASSWORD }}" \
            -Pandroid.injected.signing.key.alias="${{ secrets.KEY_ALIAS }}" \
            -Pandroid.injected.signing.key.password="${{ secrets.KEY_PASSWORD }}"

      # 11) Artifacts upload
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            android/app/build/outputs/apk/release/*.apk
            android/app/build/outputs/bundle/release/*.aab
