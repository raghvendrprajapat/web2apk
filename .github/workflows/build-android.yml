# Workflow ka Naam
name: Build Android (Signed APK & AAB)

# Yeh workflow ko 'Actions' tab se manually run karne ki anumati deta hai
on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App Name (e.g., My Awesome App)"
        required: true
        default: "My Web2APK"
      APP_ID:
        description: "Package ID (e.g., com.example.app)"
        required: true
        default: "com.example.web2apk"
      WEB_URL:
        description: "Web App URL (https://...)"
        required: true
        default: "https://example.com"
      # NEW: Yahan se aap plugin chun sakte hain
      PLUGINS:
        description: "Select which Capacitor plugins to install"
        type: choice
        required: true
        default: 'none'
        options:
          - none
          - camera
          - push-notifications
          - location
          - camera_and_push
          - all
      VERSION_NAME:
        description: "App Version Name (e.g., 1.0.1)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Unique Version Code (integer, e.g., 1)"
        required: true
        default: "1"
      CALLBACK_URL:
        description: "Make.com callback webhook URL (optional)"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      MAKE_WEBHOOK_URL: ${{ secrets.MAKE_WEBHOOK_URL }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # STEP MODIFIED: Ab yeh aapke chunav ke aadhar par plugin install karega
      - name: Install Capacitor Dependencies and Plugins
        shell: bash
        run: |
          if [ ! -f package.json ]; then
          cat > package.json <<'JSON'
          {
            "name": "web2apk-app",
            "version": "1.0.0",
            "private": true
          }
          JSON
          fi
          # Capacitor CLI, Core, aur Android platform install karta hai
          npm i -g @capacitor/cli
          npm i @capacitor/core @capacitor/android --save-exact
          
          # NEW: User ke chunav ko check karke plugins install karega
          PLUGINS_TO_INSTALL=""
          CHOICE="${{ github.event.inputs.PLUGINS }}"

          if [ "$CHOICE" = "camera" ]; then
            PLUGINS_TO_INSTALL="@capacitor/camera"
          elif [ "$CHOICE" = "push-notifications" ]; then
            PLUGINS_TO_INSTALL="@capacitor/push-notifications"
          elif [ "$CHOICE" = "location" ]; then
            PLUGINS_TO_INSTALL="@capacitor/geolocation"
          elif [ "$CHOICE" = "camera_and_push" ]; then
            PLUGINS_TO_INSTALL="@capacitor/camera @capacitor/push-notifications"
          elif [ "$CHOICE" = "all" ]; then
            PLUGINS_TO_INSTALL="@capacitor/camera @capacitor/push-notifications @capacitor/geolocation"
          fi

          if [ -n "$PLUGINS_TO_INSTALL" ]; then
            echo "Installing selected plugins: $PLUGINS_TO_INSTALL"
            npm i $PLUGINS_TO_INSTALL --save-exact
          else
            echo "No extra plugins selected."
          fi
          
          mkdir -p www
          echo '<!doctype html><html><head><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"></head><body></body></html>' > www/index.html

      # Baaki ke saare steps bilkul same hain...
      - name: Generate/Update Capacitor Config
        shell: bash
        run: |
          npx cap init \
            "${{ github.event.inputs.APP_NAME }}" \
            "${{ github.event.inputs.APP_ID }}" \
            --web-dir "www"
          npx cap config set server.url "${{ github.event.inputs.WEB_URL }}"
          npx cap config set server.androidScheme "https"
          npx cap config set android.allowMixedContent true

      - name: Add Android Platform & Sync
        run: |
          npx cap add android
          npx cap sync android
          
      - name: Set App Version in Gradle
        shell: bash
        run: |
          VERSION_NAME="${{ github.event.inputs.VERSION_NAME }}"
          VERSION_CODE="${{ github.event.inputs.VERSION_CODE }}"
          GRADLE_FILE="android/app/build.gradle"
          sed -i "s/versionName \".*\"/versionName \"$VERSION_NAME\"/" $GRADLE_FILE
          sed -i "s/versionCode .*/versionCode $VERSION_CODE/" $GRADLE_FILE

      - name: Decode Keystore
        shell: bash
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/release-key.jks

      - name: Build Signed App Bundle (AAB) and APK
        working-directory: android
        shell: bash
        run: |
          chmod +x ./gradlew
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=$PWD/release-key.jks \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$PWD/release-key.jks \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"

      - name: Upload AAB (Play Store Ready)
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: android/app/build/outputs/bundle/release/*.aab
          if-no-files-found: error
          retention-days: 7

      - name: Upload APK (for testing)
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          if-no-files-found: error
          retention-days: 7
          
