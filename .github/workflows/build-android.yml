name: Build Web -> Signed Android (Zip or Local)

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Offline App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.offline"
      WEB_ZIP_URL:
        description: "(Optional) URL to a ZIP file containing web assets. If set, local build is skipped."
        required: false
        default: ""
      VERSION_NAME:
        description: "Public version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Integer. Must increase every Play upload"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target / compile SDK"
        required: true
        default: "35"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      WEB_ZIP_URL: ${{ github.event.inputs.WEB_ZIP_URL }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      MIN_SDK: "22"
      
      # Secrets
      KEYSTORE_BASE64:   ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Prepare Web Assets (Build or Download)
        shell: bash
        run: |
          set -euo pipefail

          # 1. Check if ZIP URL is provided
          if [ -n "$WEB_ZIP_URL" ]; then
            echo "‚¨áÔ∏è Downloading web assets from URL..."
            curl -L -o web_assets.zip "$WEB_ZIP_URL"
            
            echo "üìÇ Unzipping assets..."
            unzip -q web_assets.zip -d downloaded_web
            
            # Find the folder containing index.html (handles nested folders in zip)
            FOUND_INDEX=$(find downloaded_web -name "index.html" | head -n 1)
            
            if [ -z "$FOUND_INDEX" ]; then
              echo "::error::No index.html found in the provided ZIP file!"
              exit 1
            fi
            
            # Set WEB_BUILD_DIR to the folder containing index.html
            WEB_BUILD_DIR=$(dirname "$FOUND_INDEX")
            echo "‚úÖ Found web root at: $WEB_BUILD_DIR"
            echo "WEB_BUILD_DIR=$WEB_BUILD_DIR" >> "$GITHUB_ENV"

          # 2. If no ZIP, build locally
          else
            echo "üî® No ZIP URL provided. Building from repository source..."
            if [ -f package.json ]; then
              npm install
              if npm run | grep -q " build"; then npm run build; fi
              
              # Detect build folder
              for d in dist build public; do
                if [ -d "$d" ]; then
                  echo "WEB_BUILD_DIR=$d" >> "$GITHUB_ENV"
                  break
                fi
              done
            fi
          fi

          # 3. Fallback if nothing worked
          if ! grep -q WEB_BUILD_DIR "$GITHUB_ENV" 2>/dev/null; then
             # If we are here, we might have just unzipped to a folder but env var wasn't set yet? 
             # Or local build failed to produce output.
             # Let's check if we set it in the ZIP block above.
             if [ -z "${WEB_BUILD_DIR:-}" ]; then
                echo "‚ö†Ô∏è No build directory found. Creating placeholder."
                mkdir -p minimal_www
                echo '<h1>App Loading...</h1>' > minimal_www/index.html
                echo "WEB_BUILD_DIR=minimal_www" >> "$GITHUB_ENV"
             fi
          fi
          
          # Install Capacitor CLI
          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      - name: Validate inputs & secrets
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! "${APP_ID}" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "::error::Invalid APP_ID: ${APP_ID}"
            exit 1
          fi
          if [ -z "${KEYSTORE_BASE64:-}" ]; then echo "::error::Missing KEYSTORE_BASE64 secret"; exit 1; fi

      - name: Restore keystore
        shell: bash
        run: echo "$KEYSTORE_BASE64" | base64 -d > release.keystore

      - name: Init and configure Capacitor
        shell: bash
        run: |
          set -euo pipefail
          echo "Using webDir: $WEB_BUILD_DIR"
          
          # Initialize Capacitor
          npx cap init "$APP_NAME" "$APP_ID" --web-dir="$WEB_BUILD_DIR"
          
          # Create config
          cat > capacitor.config.json <<EOF
          {
            "appId": "${APP_ID}",
            "appName": "${APP_NAME}",
            "webDir": "${WEB_BUILD_DIR}",
            "bundledWebRuntime": false,
            "android": {
              "allowMixedContent": false
            }
          }
          EOF

          npx cap add android
          npx cap sync android

      - name: Patch Gradle (Versioning)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          FILE="app/build.gradle"
          if [ ! -f "$FILE" ]; then FILE="app/build.gradle.kts"; fi
          
          sed -i -E "s/versionCode[ =]+[0-9]+/versionCode ${VERSION_CODE}/" "$FILE" || true
          sed -i -E "s/versionName[ =]+\"[^\"]+\"/versionName \"${VERSION_NAME}\"/" "$FILE" || true
          sed -i -E "s/compileSdkVersion[ =]+[0-9]+/compileSdkVersion ${TARGET_SDK}/" "$FILE" || true
          sed -i -E "s/targetSdkVersion[ =]+[0-9]+/targetSdkVersion ${TARGET_SDK}/" "$FILE" || true

      - name: Build Android Release
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          mv ../release.keystore app/release.keystore
          
          ./gradlew clean :app:bundleRelease :app:assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/release.keystore \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD \
            --no-daemon

          mkdir -p ../out_aab ../out_apk
          cp app/build/outputs/bundle/release/*.aab ../out_aab/
          cp app/build/outputs/apk/release/*.apk ../out_apk/

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release-bundle
          path: out_aab/*.aab

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: out_apk/*.apk
