name: Build Android (Signed APK & AAB)

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App Name (e.g., My Awesome App)"
        required: true
        default: "My Web2APK"
      APP_ID:
        description: "Package ID (e.g., com.example.app)"
        required: true
        default: "com.example.web2apk"
      WEB_URL:
        description: "Web App URL (https://...)"
        required: true
        default: "https://example.com"
      PLUGINS:
        description: "Capacitor plugins to include"
        type: choice
        required: true
        default: "none"
        options:
          - "none"
          - "camera"
          - "push-notifications"
          - "location"
          - "camera_and_push"
          - "all"
      VERSION_NAME:
        description: "App Version Name (e.g., 1.0.1)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Unique Version Code (integer, e.g., 1)"
        required: true
        default: "1"
      ALLOW_MIXED_CONTENT:
        description: "Allow http (non-HTTPS) content? (true/false)"
        required: true
        default: "false"
      TARGET_SDK:
        description: "Target/Compile SDK (Play 2025 rule: 35)"
        required: true
        default: "35"
      MIN_SDK:
        description: "Min SDK (Capacitor typical >=22)"
        required: true
        default: "22"

# Least privilege for the workflow token
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      # Performance tuning
      GRADLE_OPTS: "-Dorg.gradle.jvmargs='-Xmx3g -XX:+UseParallelGC' -Dorg.gradle.daemon=false"

      # Inputs as env for convenience
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      MIN_SDK: ${{ github.event.inputs.MIN_SDK }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      WEB_URL: ${{ github.event.inputs.WEB_URL }}
      ALLOW_MIXED_CONTENT: ${{ github.event.inputs.ALLOW_MIXED_CONTENT }}

      # Signing secrets (scoped to job; base64 secret is scoped per-step)
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- CACHES ----------
      - name: Cache NPM
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # ---------- VALIDATIONS ----------
      - name: Validate Inputs & Secrets
        id: validate
        shell: bash
        run: |
          set -euo pipefail
          echo "## Pre-Build Validation" >> "$GITHUB_STEP_SUMMARY"

          # Package ID format (lowercase reverse-DNS)
          if [[ ! "$APP_ID" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "Invalid APP_ID: $APP_ID" | tee -a "$GITHUB_STEP_SUMMARY"; exit 1; fi

          # Version code integer
          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            echo "VERSION_CODE must be integer" | tee -a "$GITHUB_STEP_SUMMARY"; exit 1; fi

          # HTTPS check unless mixed content explicitly allowed
          if [[ "$ALLOW_MIXED_CONTENT" != "true" && ! "$WEB_URL" =~ ^https:// ]]; then
            echo "WEB_URL must start with https:// (or set ALLOW_MIXED_CONTENT=true)" | tee -a "$GITHUB_STEP_SUMMARY"; exit 1; fi

          # SDK compliance
          if [[ "$TARGET_SDK" -lt 35 ]]; then
            echo "TARGET_SDK must be 35 (Play 2025)" | tee -a "$GITHUB_STEP_SUMMARY"; exit 1; fi
          if [[ "$MIN_SDK" -lt 22 ]]; then
            echo "MIN_SDK should be >= 22" | tee -a "$GITHUB_STEP_SUMMARY"; exit 1; fi

          # Required secrets present (except base64 which is step-scoped)
          for s in KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD; do
            [[ -z "${!s:-}" ]] && echo "Missing secret: $s" | tee -a "$GITHUB_STEP_SUMMARY" && M=1 || true
          done
          [[ "${M:-0}" -eq 1 ]] && exit 1 || echo "Inputs & secrets OK" >> "$GITHUB_STEP_SUMMARY"

      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Android SDK (API & Build-Tools)
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            platforms;android-${{ github.event.inputs.TARGET_SDK }}
            build-tools;${{ github.event.inputs.TARGET_SDK }}.0.0

      # ---------- INSTALL ----------
      - name: Install Capacitor CLI & Core (npm ci)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f package.json ]; then
            cat > package.json <<'JSON'
            { "name": "web2apk-app", "version": "1.0.0", "private": true }
            JSON
          fi
          # Deterministic install if lock exists, else fallback
          if [ -f package-lock.json ]; then npm ci; else npm i; fi
          npm i -g @capacitor/cli@latest
          npm i @capacitor/core@latest @capacitor/android@latest --save-exact

      - name: Install Selected Capacitor Plugins
        shell: bash
        run: |
          CHOICE="${{ github.event.inputs.PLUGINS }}"
          if [ "$CHOICE" = "camera" ]; then
            PLUGINS_TO_INSTALL="@capacitor/camera"
          elif [ "$CHOICE" = "push-notifications" ]; then
            PLUGINS_TO_INSTALL="@capacitor/push-notifications"
          elif [ "$CHOICE" = "location" ]; then
            PLUGINS_TO_INSTALL="@capacitor/geolocation"
          elif [ "$CHOICE" = "camera_and_push"
